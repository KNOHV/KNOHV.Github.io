<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV & HTML Artikel-Editor</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        #search { padding: 10px; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
        .table-wrapper { overflow-x: auto; max-height: 500px; border: 1px solid #ddd; border-radius: 4px; }
        table { border-collapse: collapse; width: 100%; background: white; }
        th { background-color: #4a5568; color: white; position: sticky; top: 0; padding: 12px; text-align: left; z-index: 10; }
        td { border: 1px solid #e2e8f0; padding: 8px; min-width: 120px; }
        tr:nth-child(even) { background-color: #f8fafc; }
        tr:hover { background-color: #edf2f7; }
        .btn { padding: 10px 16px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; transition: background 0.2s; }
        .btn-open { background: #3182ce; color: white; }
        .btn-save { background: #38a169; color: white; }
        .btn-add { background: #718096; color: white; }
        .btn:hover { opacity: 0.9; }
        #status { font-size: 0.85em; color: #718096; margin-left: auto; }
        [contenteditable]:focus { outline: 2px solid #3182ce; background: #fff; }
    </style>
</head>
<body>

<div class="container">
    <h2>Artikel-Datenbank Editor</h2>

    <div class="controls">
        <button class="btn btn-open" onclick="loadFile()">Datei öffnen</button>
        <button class="btn btn-save" onclick="saveFile()">Speichern</button>
        <button class="btn btn-add" onclick="addRow()">+ Neuer Artikel</button>
        <input type="text" id="search" placeholder="Suchen (z.B. Artikelnummer)..." onkeyup="filterTable()">
        <span id="status">Bereit</span>
    </div>

    <div class="table-wrapper">
        <div id="tableContainer">
            <p style="text-align:center; padding: 40px; color: #a0aec0;">Öffnen Sie eine CSV oder HTML Datei zur Bearbeitung.</p>
        </div>
    </div>
</div>

<script>
    let fileHandle;
    let detectedDelimiter = ';';

    async function loadFile() {
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types: [{
                    description: 'CSV oder HTML Dateien',
                    accept: { 'text/csv': ['.csv'], 'text/html': ['.html'] }
                }]
            });

            const file = await fileHandle.getFile();
            const content = await file.text();
            document.getElementById('status').textContent = `Datei: ${file.name}`;

            if (file.name.toLowerCase().endsWith('.csv')) {
                detectAndParseCSV(content);
            } else {
                parseHTML(content);
            }
        } catch (err) { console.log("Abgebrochen"); }
    }

    function detectAndParseCSV(text) {
        const semicolonCount = (text.match(/;/g) || []).length;
        const commaCount = (text.match(/,/g) || []).length;
        detectedDelimiter = semicolonCount >= commaCount ? ';' : ',';
        
        // CSV-Parsing mit Berücksichtigung von Anführungszeichen
        const rows = [];
        let currentRow = [];
        let currentField = '';
        let inQuotes = false;

        // Einfaches Regex für CSV-Zeilen (berücksichtigt Quoting)
        const lines = text.split(/\r?\n/);
        
        lines.forEach(line => {
            if (line.trim() === '') return;
            const fields = [];
            let field = '';
            let escaped = false;
            for (let char of line) {
                if (char === '"' && !escaped) inQuotes = !inQuotes;
                else if (char === detectedDelimiter && !inQuotes) {
                    fields.push(field.trim());
                    field = '';
                } else field += char;
            }
            fields.push(field.trim());
            rows.push(fields);
        });

        renderTable(rows);
    }

    function parseHTML(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const rows = Array.from(doc.querySelectorAll('tr')).map(tr => 
            Array.from(tr.querySelectorAll('td, th')).map(cell => cell.innerText.trim())
        );
        renderTable(rows);
    }

    function renderTable(data) {
        if (!data || data.length === 0) return;
        let html = `<table id="dataTable"><thead><tr>`;
        data[0].forEach(h => html += `<th>${h || 'Spalte'}</th>`);
        html += `</tr></thead><tbody>`;

        for (let i = 1; i < data.length; i++) {
            html += `<tr>`;
            data[i].forEach(cell => html += `<td contenteditable="true">${cell}</td>`);
            html += `</tr>`;
        }
        html += `</tbody></table>`;
        document.getElementById('tableContainer').innerHTML = html;
    }

    function addRow() {
        const table = document.querySelector("#dataTable tbody");
        if (!table) return alert("Zuerst eine Datei öffnen!");
        const colCount = document.querySelectorAll("#dataTable th").length;
        const row = table.insertRow();
        for (let i = 0; i < colCount; i++) {
            const cell = row.insertCell();
            cell.contentEditable = "true";
        }
        row.scrollIntoView();
    }

    function filterTable() {
        const query = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('#dataTable tbody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none';
        });
    }

    async function saveFile() {
        if (!fileHandle) return alert("Keine Datei geladen!");
        const table = document.getElementById('dataTable');
        const rows = Array.from(table.rows);
        let output = "";

        if (fileHandle.name.toLowerCase().endsWith('.csv')) {
            // Sicherer CSV Export mit Quoting
            output = rows.map(row => {
                return Array.from(row.cells).map(cell => {
                    let val = cell.innerText.replace(/"/g, '""'); // Anführungszeichen verdoppeln
                    return `"${val}"`; // Jedes Feld in Quotes setzen
                }).join(detectedDelimiter);
            }).join('\r\n');
        } else {
            // HTML Export
            const tableBody = rows.map(row => `<tr>${Array.from(row.cells).map(c => `<td>${c.innerText}</td>`).join('')}</tr>`).join('\n');
            output = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body><table border="1">${tableBody}</table></body></html>`;
        }

        try {
            const writable = await fileHandle.createWritable();
            // UTF-8 BOM hinzufügen, damit Excel Umlaute erkennt
            if (fileHandle.name.endsWith('.csv')) await writable.write(new Uint8Array([0xEF, 0xBB, 0xBF]));
            await writable.write(output);
            await writable.close();
            alert("Erfolgreich gespeichert!");
        } catch (err) { alert("Fehler: " + err.message); }
    }
</script>
</body>
</html>
